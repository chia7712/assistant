#!/bin/bash

nodes=()

# Read the file in parameter and fill the array named "array"
getArray() {
  i=0
  while read line # Read a line
  do
    if [ "$line" != "$HOSTNAME" ] ; then
      nodes[i]=$line # Put it into the array
      i=$(($i + 1))
    fi
  done < $1
}

getArray "hosts"
SSH_CMD="ssh -p 12280"
SCP_CMD="scp -r -P 12280"
HBASE_VERSION=3.0.0-SNAPSHOT
HBASE_REMOTE_HOME=/home/chia7712/hbase-$HBASE_VERSION
HBASE_REMOTE_LIB=$HBASE_REMOTE_HOME/lib
HBASE_REMOTE_CLEAN="rm -rf "$HBASE_REMOTE_LIB
HBASE_LOCAL_HOME=$HOME/hbase-$HBASE_VERSION
HBASE_LOCAL_LIB=$HBASE_LOCAL_HOME/lib
HBASE_LOCAL_CLEAN="rm -rf "$HBASE_LOCAL_LIB
HBASE_SRC=$HOME/hbase
HBASE_ASSEMBLY=$HBASE_SRC/hbase-assembly/target
HBASE_GZ="hbase-"$HBASE_VERSION"-bin.tar.gz"
HBASE_TARGET=$HBASE_ASSEMBLY/$HBASE_GZ
HBASE_SRC_LIB="$HBASE_ASSEMBLY"/hbase-"$HBASE_VERSION"/lib
tar -zxvf $HBASE_TARGET -C $HBASE_ASSEMBLY"/"
$HBASE_LOCAL_CLEAN
cp -r $HBASE_SRC_LIB $HBASE_LOCAL_LIB
for node in ${nodes[@]}
do
  echo "clean "$node
  $SSH_CMD $node $HBASE_REMOTE_CLEAN
done
for node in ${nodes[@]}
do
  echo "sync "$node
  $SCP_CMD $HBASE_SRC_LIB $node:$HBASE_REMOTE_HOME/
done
