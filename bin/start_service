#!/bin/bash

nodes=()

# Read the file in parameter and fill the array named "array"
getArray() {
    i=0
    while read line # Read a line
    do
        nodes[i]=$line # Put it into the array
        i=$(($i + 1))
    done < $1
}

getArray "hosts"
SSH_PORT=12280
SSH_CMD='ssh -p '$SSH_PORT
USER=chia7712
HBASE_HOME=/home/$USER/hbase-2.0.0-SNAPSHOT
HADOOP_HOME=/home/$USER/hadoop-2.7.1
ZOOKEEPER_DATA_HOME=/home/$USER/zookeeper
CLEAN_HBASE='rm -rf '$HBASE_HOME'/logs'
CLEAN_HBASE_PID='rm -rf /tmp/hbase*'
CLEAN_HADOOP='rm -rf '$HADOOP_HOME'/logs'
CLEAN_HADOOP_PID='rm -rf /tmp/hadoop*'
CLEAN_ZOOKEEPER='rm -rf '$ZOOKEEPER_DATA_HOME
START_HBASE=$HBASE_HOME'/bin/start-hbase.sh'
FORMAT_NAMENODE=$HADOOP_HOME'/bin/hdfs namenode -format -force'
START_HDFS=$HADOOP_HOME'/sbin/start-dfs.sh'
START_YARN=$HADOOP_HOME'/sbin/start-yarn.sh'
START_JS=$HADOOP_HOME'/sbin/mr-jobhistory-daemon.sh start historyserver'
MASTER=cat01
NODEMANAGER=cat01
NAMENODE=cat01
echo "stop firewall"

#for node in ${nodes[@]}
#do
#  $SSH_CMD $node 'systemctl stop firewalld'
#done

echo "clean zookeeper"
for node in ${nodes[@]}
do
  $SSH_CMD $node $CLEAN_ZOOKEEPER
done


echo "clean hbase"
for node in ${nodes[@]}
do
  $SSH_CMD $node $CLEAN_HBASE
  $SSH_CMD $node $CLEAN_HBASE_PID
done

echo "clean hadoop"
for node in ${nodes[@]}
do
  $SSH_CMD $node $CLEAN_HADOOP
  $SSH_CMD $node $CLEAN_HADOOP_PID
done

$SSH_CMD $NAMENODE $FORMAT_NAMENODE
$SSH_CMD $NAMENODE $START_HDFS
if [ "$1" == "all" ];then
  echo "start YARN"
  $SSH_CMD $NODEMANAGER $START_YARN
  $SSH_CMD $NODEMANAGER $START_JS
fi
$SSH_CMD $MASTER $START_HBASE
