#!/bin/bash

HBASE_HOME=$HOME/hbase
HBASE_SERVER_REPORTS=$HOME/hbase/hbase-server/target/surefire-reports
HBASE_CLIENT_REPORTS=$HOME/hbase/hbase-client/target/surefire-reports
CLOSE_FLAG="/tmp/assistant_ut_stop"
nodes=()

# Read the file in parameter and fill the array named "array"
getArray() {
    i=0
    while read line # Read a line
    do
        nodes[i]=$line # Put it into the array
        i=$(($i + 1))
    done < $1
}

getArray "hosts"
SCP_CMD='scp -P 12280'
if [ "$1" == "stop_all" ] ; then
  for node in ${nodes[@]}
  do
    echo "stop" >> $CLOSE_FLAG
    $SCP_CMD $CLOSE_FLAG $node:$CLOSE_FLAG
  done
  exit
fi
if [ "$1" == "" ] || [ "$2" == "" ] ; then
  echo "<UT> <OUTPUT> [TIMES]"
  echo "<stop_all>"
  exit
fi
UT_NAME=$1
OUTPUT=$2
TIMES=''
if [ "$3" == "" ]; then
  TIMES=9999
else
  TIMES=$3
fi
cd $HBASE_HOME
i=0
while [ "${i}" != "$TIMES" ]
do
  if [ -f $CLOSE_FLAG ] ; then
    rm -f $CLOSE_FLAG
    exit
  fi
  CURRENT_OUTPUT=$OUTPUT/$i
  if [ -d "$CURRENT_OUTPUT" ]; then
    echo "folder exists:"$CURRENT_OUTPUT
    exit
  fi
  file="$CURRENT_OUTPUT/console_$i"
  mkdir $CURRENT_OUTPUT
  mvn clean test -Dtest=$UT_NAME -P skipSparkTests | tee $file
  if [ -d "$HBASE_SERVER_REPORTS" ]; then
    mkdir $CURRENT_OUTPUT/hbase-server
    cp -r $HBASE_SERVER_REPORTS $CURRENT_OUTPUT/hbase-server/
  fi
  if [ -d "$HBASE_CLIENT_REPORTS" ]; then
    mkdir $CURRENT_OUTPUT/hbase-client
    cp -r $HBASE_CLIENT_REPORTS $CURRENT_OUTPUT/hbase-client/
  fi
  i=$(($i+1))
  name=''
  successCount=0
  while read -r name
  do
    if [ "$name" == "[INFO] BUILD SUCCESS" ] ; then
      successCount=$(($successCount+1))
    fi
  done < $file
  if [ $successCount -eq 0 ] ; then
    exit
  fi
done