#!/bin/bash

HBASE_HOME=$HOME/hbase
HBASE_SERVER_REPORTS=$HOME/hbase/hbase-server/target/surefire-reports
HBASE_CLIENT_REPORTS=$HOME/hbase/hbase-client/target/surefire-reports
if [ "$1" == "" ] || [ "$2" == "" ] ; then
  echo "<UT> <OUTPUT> [TIMES]"
  exit
fi
UT_NAME=$1
OUTPUT=$2
TIMES=''
if [ "$3" == "" ]; then
  TIMES=9999
else
  TIMES=$3
fi
cd $HBASE_HOME
i=0
while [ "${i}" != "$TIMES" ]
do
  CURRENT_OUTPUT=$OUTPUT/$i
  if [ -d "$CURRENT_OUTPUT" ]; then
    echo "folder exists:"$CURRENT_OUTPUT
    exit
  fi
  file="$CURRENT_OUTPUT/console_$i"
  mkdir $CURRENT_OUTPUT
  mvn clean test -Dtest=$UT_NAME -P skipSparkTests > $file
  if [ -d "$HBASE_SERVER_REPORTS" ]; then
    mkdir $CURRENT_OUTPUT/hbase-server
    cp -r $HBASE_SERVER_REPORTS $CURRENT_OUTPUT/hbase-server/
  fi
  if [ -d "$HBASE_CLIENT_REPORTS" ]; then
    mkdir $CURRENT_OUTPUT/hbase-client
    cp -r $HBASE_CLIENT_REPORTS $CURRENT_OUTPUT/hbase-client/
  fi
  i=$(($i+1))
  name=''
  while read -r name
  do
    if [ "$name" == "[INFO] BUILD FAILURE" ] ; then
      exit;
    fi
  done < $file
done